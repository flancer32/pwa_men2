<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="description" content="Your project description.">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>TeqFW App</title>
    <link rel="manifest" href="pwa.webmanifest">
    <script>
        async function bootstrap() {

            // DEFINE INNER FUNCTIONS
            /**
             * Import code, create and setup Dependency Injection container for frontend.
             *
             * @returns {Promise<TeqFw_Di_Container>}
             */
            async function initDiContainer() {

                // DEFINE INNER FUNCTIONS
                /**
                 * @returns {Promise<TeqFw_Core_App_Shared_Api_Route_Load_Namespaces_Response>}
                 */
                async function loadNamespaces() {
                    // load frontend configuration and user profile
                    const res = await fetch('./api/core/load/namespaces');
                    const json = await res.json();
                    return json.data;
                }

                // MAIN FUNCTIONALITY
                const baseUrl = location.origin;
                // create and setup DI Container
                const modContainer = await import('./src/@teqfw/di/Container.mjs');
                /** @type {TeqFw_Di_Container} */
                const result = new modContainer.default();
                const response = await loadNamespaces();
                if (response && response.items) {
                    for (const key of Object.keys(response.items)) {
                        const item = response.items[key];
                        result.addSourceMapping(item.ns, baseUrl + item.path, true, item.ext);
                    }
                }
                return result;
            }

            /**
             * Load frontend configuration from API using simple 'fetch'.
             *
             * @param {TeqFw_Di_Container} container
             * @returns {Promise<{TeqFw_Core_App_Front_Data_Config}>}
             */
            async function loadConfig(container) {
                // load frontend configuration and user profile
                const res = await fetch('./api/core/load/config');
                const json = await res.json();
                const DConfig = await container.get('TeqFw_Core_App_Front_Data_Config#'); // class constructor
                return Object.assign(new DConfig(), json.data);
            }

            /**
             * Initialize 'i18next' library to use internationalization.
             *
             * @param {Object} app
             * @returns {Promise<i18n>}
             */
            async function initI18n(app) {
                self.i18next.use(self.i18nextBrowserLanguageDetector);
                await self.i18next.init({});
                const appProps = app.config.globalProperties;
                // arrow function uses current scope with 'self'
                appProps.$t = (key, options) => {
                    return self.i18next.t(key, options);
                };
                return self.i18next;
            }

            /**
             * Create and initialize Vue3 router.
             *
             * @returns {*}
             */
            function initRouter() {
                return self.VueRouter.createRouter({
                    history: self.VueRouter.createWebHashHistory(),
                    routes: []
                });
            }

            // MAIN FUNCTIONALITY
            try {
                // initialize objects loader (Dependency Injection container)
                const container = await initDiContainer();
                /** @type {Fl32_Men2_Defaults} */
                const DEF = await container.get('Fl32_Men2_Defaults$');  // instance singleton
                // load configuration from server and place it into DI container
                const config = await loadConfig(container);
                container.set(DEF.DI_CONFIG, config);
                // save old-style loaded JS objects into DI container (see <script src="..."> at the end of HTML)
                // container.set(DEF.DI_VUE, self.Vue);
                // container.set(DEF.DI_VUEX, self.Vuex);
                // container.set(DEF.DI_VUE_ROUTER, self.VueRouter);
                // create vue application, init router and i18n
                const app = self.Vue.createApp({
                    data: function () {
                        return {test: 'Hello from Vue!'}
                    }
                });
                // const router = initRouter();
                // const i18next = await initI18n(app);
                app.mount('BODY > DIV');
            } catch (e) {
                console.error("Error in bootstrap: " + e + "\n" + e.stack);
            }
        }

        if ("serviceWorker" in navigator) { // if browser supports service workers
            // ... then add event handler to run script after window will be loaded
            // (https://developer.mozilla.org/en-US/docs/Web/API/Window/load_event)
            self.addEventListener("load", async () => {
                const container = navigator.serviceWorker;
                if (container.controller === null) {
                    // ... to load "sw.js" script and register service worker in navigator
                    try {
                        const reg = await container.register("sw.js");
                        if (reg.active) {
                            console.log("SW is registered and is active.", reg);
                            await bootstrap();
                        } else {
                            console.log("SW is registered but is not activated yet.", reg);
                            // wait for `controllerchange` (see `clients.claim()` in SW code on `activate` event)
                            container.addEventListener("controllerchange", async () => {
                                // SW just installed (page's first load).
                                await bootstrap();
                            });
                        }
                    } catch (e) {
                        console.error("SW registration is failed: " + e + "\n" + e.stack)
                    }
                } else {
                    // SW already installed before (repeated loading of the page).
                    console.log("SW is already running for this app.");
                    await bootstrap();
                }

            });
        }
    </script>
</head>
<body>
<div>{{ test }}</div>
<script type="application/javascript" src="./src/vue/vue.global.js"></script>
<script type="application/javascript" src="./src/vue-router/vue-router.global.js"></script>
<script type="application/javascript" src="./src/vuex/vuex.global.js"></script>
<script type="application/javascript" src="./src/i18next/i18next.min.js"></script>
<script type="application/javascript" src="./src/i18next-detect/i18nextBrowserLanguageDetector.js"></script>
</body>
</html>
